@page "/prompts"
@inject PromptService PromptService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>í”„ë¡¬í”„íŠ¸ ëª©ë¡ - MEGAZONE AIR Prompt</PageTitle>

<div class="prompt-gallery">
    <header class="gallery-header">
        <h1 class="gallery-title">ğŸ“š í”„ë¡¬í”„íŠ¸ ëª©ë¡</h1>
        <p class="gallery-subtitle">ëª¨ë“  AI í”„ë¡¬í”„íŠ¸ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        
        <div class="search-section">
            <div class="search-container">
                <input @bind="searchTerm" @oninput="OnSearchInput" 
                       placeholder="í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰..." class="search-input" />
                <button class="search-btn" @onclick="SearchPrompts">
                    ğŸ”
                </button>
            </div>
              <div class="filter-section">
                <select @bind="selectedCategory" class="category-filter">
                    <option value="">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
                    @if (categories != null)
                    {
                        @foreach (var category in categories)
                        {
                            <option value="@category">@category</option>
                        }
                    }
                </select>
                  <div class="favorite-filter">
                    <label class="favorite-toggle">
                        <input type="checkbox" @bind="ShowFavoritesOnly" />
                        <span class="checkmark">ğŸ’–</span>
                        <span class="label-text">ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°</span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <main class="gallery-content">
        @if (isLoading)
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        }
        else if (displayedPrompts?.Any() == true)
        {
            <div class="prompts-stats">
                <p>ì´ @(allPrompts?.Count ?? 0)ê°œ ì¤‘ @(displayedPrompts.Count)ê°œì˜ í”„ë¡¬í”„íŠ¸</p>
            </div>
              <div class="prompts-grid">
                @foreach (var prompt in displayedPrompts)
                {
                    <PromptCard Prompt="prompt" OnCardClick="ViewPrompt" />
                }
            </div>
        }
        else
        {
            <div class="no-results">
                <div class="no-results-icon">ğŸ“</div>
                <h3>@(string.IsNullOrEmpty(searchTerm) ? "í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤" : "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤")</h3>
                <p>@(string.IsNullOrEmpty(searchTerm) ? "í”„ë¡¬í”„íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”." : "ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.")</p>
            </div>
        }
    </main>
</div>

<PromptModal Prompt="selectedPrompt" 
             OnClose="CloseModal"
             OnCopyToClipboard="CopyToClipboard"
             OnToggleFavorite="ToggleFavorite" />

@code
{
    private List<PromptItem>? allPrompts;
    private List<PromptItem>? displayedPrompts;
    private List<string>? categories;
    private string searchTerm = "";
    private string _selectedCategory = "";
    private bool showFavoritesOnly = false;
    private bool isLoading = true;
    private PromptItem? selectedPrompt; private string selectedCategory
    {
        get => _selectedCategory;
        set
        {
            if (_selectedCategory != value)
            {
                _selectedCategory = value;
                ApplyFilters();
            }
        }
    }

    private bool ShowFavoritesOnly
    {
        get => showFavoritesOnly;
        set
        {
            if (showFavoritesOnly != value)
            {
                showFavoritesOnly = value;
                ApplyFilters();
            }
        }
    }    protected override async Task OnInitializedAsync()
    {
        // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
        var uri = new Uri(Navigation.Uri);
        var query = uri.Query;

        if (!string.IsNullOrEmpty(query))
        {
            var queryParams = query.TrimStart('?').Split('&');
            foreach (var param in queryParams)
            {
                var keyValue = param.Split('=');
                if (keyValue.Length == 2)
                {
                    var key = Uri.UnescapeDataString(keyValue[0]);
                    var value = Uri.UnescapeDataString(keyValue[1]);

                    if (key == "search")
                    {
                        searchTerm = value;
                    }
                    else if (key == "category")
                    {
                        _selectedCategory = value;
                    }
                    else if (key == "promptId")
                    {
                        // íŠ¹ì • í”„ë¡¬í”„íŠ¸ IDê°€ ì „ë‹¬ëœ ê²½ìš°, í•´ë‹¹ í”„ë¡¬í”„íŠ¸ë¥¼ ë°”ë¡œ í‘œì‹œ
                        await ShowPromptById(value);
                        return; // ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•Šê³  í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ë§Œ í‘œì‹œ
                    }
                }
            }
        }

        await LoadInitialData();
        await LoadData();
    }

    private async Task LoadInitialData()
    {
        try
        {
            // ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë¨¼ì € ë¹ ë¥´ê²Œ ë¡œë“œ (ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë§Œ ì‚¬ìš©)
            categories = await PromptService.GetCategoriesFromManifestAsync();
            StateHasChanged(); // UI ì—…ë°ì´íŠ¸ë¡œ ì¹´í…Œê³ ë¦¬ í•„í„°ë¥¼ ë¹ ë¥´ê²Œ í‘œì‹œ
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading initial data: {ex.Message}");
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            allPrompts = await PromptService.GetAllPromptsAsync();
            
            // ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ í”„ë¡¬í”„íŠ¸ì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬ í¬í•¨)
            categories = await PromptService.GetCategoriesAsync();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë³µì›
            await LoadFavoritesFromStorage();

            // í•„í„° ì ìš©
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            allPrompts = new List<PromptItem>();
            displayedPrompts = new List<PromptItem>();
            categories = new List<string>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void SearchPrompts()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (allPrompts == null) return;

        var filtered = allPrompts.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(p =>
                p.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.Tags.Any(t => t.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            );
        }

        if (!string.IsNullOrWhiteSpace(selectedCategory))
        {
            filtered = filtered.Where(p => p.Category.Equals(selectedCategory, StringComparison.OrdinalIgnoreCase));
        }

        if (showFavoritesOnly)
        {
            filtered = filtered.Where(p => p.IsFavorite);
        }

        displayedPrompts = filtered.OrderByDescending(p => p.UpdatedDate).ToList();
        StateHasChanged();
    }

    private void ViewPrompt(string promptId)
    {
        selectedPrompt = allPrompts?.FirstOrDefault(p => p.Id == promptId);
        StateHasChanged();
    }

    private void CloseModal()
    {
        selectedPrompt = null;
        StateHasChanged();
    }

    private async Task CopyToClipboard(string content)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", content);
            // ê°„ë‹¨í•œ ì•Œë¦¼ì„ ìœ„í•´ ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥ (ì‹¤ì œë¡œëŠ” í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
            Console.WriteLine("í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private async Task ToggleFavorite(PromptItem prompt)
    {
        prompt.IsFavorite = !prompt.IsFavorite;

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¦ê²¨ì°¾ê¸° ìƒíƒœ ì €ì¥
        await SaveFavoritesToStorage();

        // í˜„ì¬ ì¦ê²¨ì°¾ê¸° í•„í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í‘œì‹œ ëª©ë¡ ì—…ë°ì´íŠ¸
        if (showFavoritesOnly)
        {
            ApplyFilters();
        }
        else
        {
            StateHasChanged();
        }
    }    private async Task LoadFavoritesFromStorage()
    {
        try
        {
            var favoritesJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "favorites");
            if (!string.IsNullOrEmpty(favoritesJson))
            {
                var favoriteIds = System.Text.Json.JsonSerializer.Deserialize<List<string>>(favoritesJson);
                if (favoriteIds != null)
                {
                    // ì „ì²´ í”„ë¡¬í”„íŠ¸ ëª©ë¡ì´ ìˆëŠ” ê²½ìš°
                    if (allPrompts != null)
                    {
                        foreach (var prompt in allPrompts)
                        {
                            prompt.IsFavorite = favoriteIds.Contains(prompt.Id);
                        }
                    }
                    
                    // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ìˆëŠ” ê²½ìš°
                    if (selectedPrompt != null)
                    {
                        selectedPrompt.IsFavorite = favoriteIds.Contains(selectedPrompt.Id);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load favorites from storage: {ex.Message}");
        }
    }    private async Task SaveFavoritesToStorage()
    {
        try
        {
            var favoriteIds = new List<string>();
            
            // ì „ì²´ í”„ë¡¬í”„íŠ¸ ëª©ë¡ì—ì„œ ì¦ê²¨ì°¾ê¸° ì¶”ì¶œ
            if (allPrompts != null)
            {
                favoriteIds.AddRange(allPrompts.Where(p => p.IsFavorite).Select(p => p.Id));
            }
            
            // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ì¦ê²¨ì°¾ê¸°ì¸ ê²½ìš° ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            if (selectedPrompt?.IsFavorite == true && !favoriteIds.Contains(selectedPrompt.Id))
            {
                favoriteIds.Add(selectedPrompt.Id);
            }
            
            // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°ëœ ê²½ìš° ì œê±°
            if (selectedPrompt?.IsFavorite == false)
            {
                favoriteIds.Remove(selectedPrompt.Id);
            }

            var favoritesJson = System.Text.Json.JsonSerializer.Serialize(favoriteIds.Distinct().ToList());
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "favorites", favoritesJson);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to save favorites to storage: {ex.Message}");
        }
    }

    private async Task ShowPromptById(string promptId)
    {
        try
        {
            // ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ë¨¼ì € ë¡œë“œ
            await LoadInitialData();
            
            // íŠ¹ì • í”„ë¡¬í”„íŠ¸ë§Œ ë¡œë“œ
            selectedPrompt = await PromptService.GetPromptByIdAsync(promptId);
            
            if (selectedPrompt != null)
            {
                // ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë³µì›
                await LoadFavoritesFromStorage();
                StateHasChanged();
            }
            else
            {
                // í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° ì „ì²´ ëª©ë¡ìœ¼ë¡œ ì´ë™
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading specific prompt: {ex.Message}");
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì „ì²´ ëª©ë¡ìœ¼ë¡œ ì´ë™
            await LoadData();
        }
    }
}
