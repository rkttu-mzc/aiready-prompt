@page "/prompts"
@inject PromptService PromptService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>í”„ë¡¬í”„íŠ¸ ëª©ë¡ - MEGAZONE AIR Prompt</PageTitle>

<div class="prompt-gallery">
    <header class="gallery-header">
        <h1 class="gallery-title">ğŸ“š í”„ë¡¬í”„íŠ¸ ëª©ë¡</h1>
        <p class="gallery-subtitle">ëª¨ë“  AI í”„ë¡¬í”„íŠ¸ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
          <div class="search-section">
            <div class="search-container">
                <input @bind="searchTerm" @oninput="OnSearchInput" 
                       placeholder="í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰..." class="search-input" />
            </div>
              <div class="filter-section">
                <select @bind="selectedCategory" class="category-filter">
                    <option value="">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
                    @if (categories != null)
                    {
                        @foreach (var category in categories)
                        {
                            <option value="@category">@category</option>
                        }
                    }
                </select>
                  <div class="favorite-filter">
                    <label class="favorite-toggle">
                        <input type="checkbox" @bind="ShowFavoritesOnly" />
                        <span class="checkmark">ğŸ’–</span>
                        <span class="label-text">ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°</span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <main class="gallery-content">
        @if (isLoading && !displayedPrompts.Any())
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        }
        else if (displayedPrompts?.Any() == true)
        {
            <div class="prompts-stats">
                <p>ì´ @(allPrompts?.Count ?? 0)ê°œ ì¤‘ @(displayedPrompts.Count)ê°œì˜ í”„ë¡¬í”„íŠ¸</p>                @if (isLoading)
                {
                    <span class="loading-more">ë” ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                }
            </div>            <div class="prompts-grid">
                @for (int i = 0; i < displayedPrompts.Count; i++)
                {
                    var prompt = displayedPrompts[i];
                    var batchIndex = i; // ë°°ì¹˜ ì¸ë±ìŠ¤ ê³„ì‚°
                    <PromptCard Prompt="prompt" 
                               BatchIndex="batchIndex" 
                               ShowAnimation="true"
                               OnCardClick="ViewPrompt" 
                               OnToggleFavorite="ToggleFavorite" />
                }
            </div>
        }
        else
        {
            <div class="no-results">
                <div class="no-results-icon">ğŸ“</div>
                <h3>@(string.IsNullOrEmpty(searchTerm) ? "í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤" : "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤")</h3>
                <p>@(string.IsNullOrEmpty(searchTerm) ? "í”„ë¡¬í”„íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”." : "ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.")</p>
            </div>
        }
    </main>
</div>

<PromptModal Prompt="selectedPrompt" 
             OnClose="CloseModal"
             OnCopyToClipboard="CopyToClipboard"
             OnToggleFavorite="ToggleFavorite" />

@code
{
    private List<PromptItem>? allPrompts;
    private List<PromptItem> displayedPrompts = new();
    private List<string>? categories;
    private string searchTerm = string.Empty;
    private string _selectedCategory = string.Empty;
    private bool showFavoritesOnly = false;    private bool isLoading = true;
    private PromptItem? selectedPrompt;

    private CancellationTokenSource? _loadingCancellationTokenSource;private string selectedCategory
    {
        get => _selectedCategory;
        set
        {
            if (_selectedCategory != value)
            {
                _selectedCategory = value;
                ApplyFilters();
            }
        }
    }

    private bool ShowFavoritesOnly
    {
        get => showFavoritesOnly;
        set
        {
            if (showFavoritesOnly != value)
            {
                showFavoritesOnly = value;
                ApplyFilters();
            }
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
        var uri = new Uri(Navigation.Uri);
        var query = uri.Query;
        string? promptIdToShow = null;

        if (!string.IsNullOrEmpty(query))
        {
            var queryParams = query.TrimStart('?').Split('&');
            foreach (var param in queryParams)
            {
                var keyValue = param.Split('=');
                if (keyValue.Length == 2)
                {
                    var key = Uri.UnescapeDataString(keyValue[0]);
                    var value = Uri.UnescapeDataString(keyValue[1]);

                    if (key == "search")
                    {
                        searchTerm = value;
                    }
                    else if (key == "category")
                    {
                        _selectedCategory = value;
                    }
                    else if (key == "promptId")
                    {
                        promptIdToShow = value;
                    }
                }
            }
        }

        await LoadInitialData();
        await LoadData();
        
        // íŠ¹ì • í”„ë¡¬í”„íŠ¸ IDê°€ ì „ë‹¬ëœ ê²½ìš°, ë¡œë”© ì™„ë£Œ í›„ í•´ë‹¹ í”„ë¡¬í”„íŠ¸ë¥¼ í‘œì‹œ
        if (!string.IsNullOrEmpty(promptIdToShow))
        {
            selectedPrompt = allPrompts?.FirstOrDefault(p => p.Id == promptIdToShow);
            
            if (selectedPrompt == null)
            {
                // í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°, ê°œë³„ ë¡œë“œ ì‹œë„
                selectedPrompt = await PromptService.GetPromptByIdAsync(promptIdToShow);
                
                if (selectedPrompt != null)
                {
                    // ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë³µì›
                    await RestoreFavoriteState(selectedPrompt);
                }
            }
            
            StateHasChanged();
        }
    }

    private async Task LoadInitialData()
    {
        try
        {
            // ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë¨¼ì € ë¹ ë¥´ê²Œ ë¡œë“œ (ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë§Œ ì‚¬ìš©)
            categories = await PromptService.GetCategoriesFromManifestAsync();
            StateHasChanged(); // UI ì—…ë°ì´íŠ¸ë¡œ ì¹´í…Œê³ ë¦¬ í•„í„°ë¥¼ ë¹ ë¥´ê²Œ í‘œì‹œ
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading initial data: {ex.Message}");
        }
    }
      private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // ì´ì „ ë¡œë”© ì‘ì—…ì´ ìˆë‹¤ë©´ ì·¨ì†Œ
            _loadingCancellationTokenSource?.Cancel();
            _loadingCancellationTokenSource = new CancellationTokenSource();
            
            displayedPrompts.Clear();
            allPrompts = new List<PromptItem>();

            var batchSize = 5; // í•œ ë²ˆì— 5ê°œì”© ë°°ì¹˜ë¡œ ì²˜ë¦¬
            var currentBatch = new List<PromptItem>();
            var lastUpdateTime = DateTime.Now;

            // IAsyncEnumerableì„ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
            await foreach (var prompt in PromptService.GetPromptsAsyncEnumerable().WithCancellation(_loadingCancellationTokenSource.Token))
            {
                allPrompts.Add(prompt);
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë³µì›
                await RestoreFavoriteState(prompt);

                // í•„í„° ì¡°ê±´ì— ë§ëŠ”ì§€ í™•ì¸í•˜ê³  ë°°ì¹˜ì— ì¶”ê°€
                if (ShouldDisplayPrompt(prompt))
                {
                    currentBatch.Add(prompt);
                }

                // ë°°ì¹˜ê°€ ê°€ë“ ì°¼ê±°ë‚˜ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ í›„ 200msê°€ ì§€ë‚¬ìœ¼ë©´ UI ì—…ë°ì´íŠ¸
                var now = DateTime.Now;
                if (currentBatch.Count >= batchSize || (now - lastUpdateTime).TotalMilliseconds > 200)
                {
                    displayedPrompts.AddRange(currentBatch);
                    currentBatch.Clear();
                    lastUpdateTime = now;
                    StateHasChanged(); // ë°°ì¹˜ ë‹¨ìœ„ë¡œ UI ì—…ë°ì´íŠ¸
                    
                    // ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì ì‹œ ëŒ€ê¸°
                    await Task.Delay(50, _loadingCancellationTokenSource.Token);
                }
            }

            // ë‚¨ì€ ë°°ì¹˜ ì²˜ë¦¬
            if (currentBatch.Any())
            {
                displayedPrompts.AddRange(currentBatch);
                StateHasChanged();
            }
            
            // ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ í”„ë¡¬í”„íŠ¸ì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬ í¬í•¨)
            categories = await PromptService.GetCategoriesAsync();

            // ìµœì¢… ì •ë ¬ ì ìš©
            ApplyFinalSorting();
        }
        catch (OperationCanceledException)
        {
            // ì·¨ì†Œëœ ê²½ìš° ë¬´ì‹œ
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            allPrompts = new List<PromptItem>();
            displayedPrompts = new List<PromptItem>();
            categories = new List<string>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        
        // ê¸°ì¡´ ë¡œë”© ì·¨ì†Œ
        _loadingCancellationTokenSource?.Cancel();
          // ê²€ìƒ‰ì–´ê°€ ë³€ê²½ë˜ë©´ ì¦‰ì‹œ ì¬í•„í„°ë§
        if (allPrompts != null)
        {
            ApplyFilters();
        }
    }
    
    private void ApplyFilters()
    {
        if (allPrompts == null) return;

        var filtered = allPrompts.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(p =>
                p.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.Tags.Any(t => t.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            );
        }

        if (!string.IsNullOrWhiteSpace(selectedCategory))
        {
            filtered = filtered.Where(p => p.Category.Equals(selectedCategory, StringComparison.OrdinalIgnoreCase));
        }

        if (showFavoritesOnly)
        {
            filtered = filtered.Where(p => p.IsFavorite);
        }

        displayedPrompts = filtered.OrderByDescending(p => p.UpdatedDate).ToList();
        StateHasChanged();
    }

    private bool ShouldDisplayPrompt(PromptItem prompt)
    {
        // ê²€ìƒ‰ì–´ í•„í„°
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var matches = prompt.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                         prompt.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                         prompt.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                         prompt.Tags.Any(t => t.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            if (!matches) return false;
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„°
        if (!string.IsNullOrWhiteSpace(selectedCategory))
        {
            if (!prompt.Category.Equals(selectedCategory, StringComparison.OrdinalIgnoreCase))
                return false;
        }

        // ì¦ê²¨ì°¾ê¸° í•„í„°
        if (showFavoritesOnly)
        {
            if (!prompt.IsFavorite) return false;
        }

        return true;
    }

    private void ApplyFinalSorting()
    {
        displayedPrompts = displayedPrompts.OrderByDescending(p => p.UpdatedDate).ToList();
        StateHasChanged();
    }

    private async Task RestoreFavoriteState(PromptItem prompt)
    {
        try
        {
            var favoritesJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "favorites");
            if (!string.IsNullOrEmpty(favoritesJson))
            {
                var favoriteIds = System.Text.Json.JsonSerializer.Deserialize<List<string>>(favoritesJson);
                if (favoriteIds != null)
                {
                    prompt.IsFavorite = favoriteIds.Contains(prompt.Id);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to restore favorite state for {prompt.Id}: {ex.Message}");
        }
    }

    private void ViewPrompt(string promptId)
    {
        selectedPrompt = allPrompts?.FirstOrDefault(p => p.Id == promptId);
        StateHasChanged();
    }

    private void CloseModal()
    {
        selectedPrompt = null;
        StateHasChanged();
    }

    private async Task CopyToClipboard(string content)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", content);
            // ê°„ë‹¨í•œ ì•Œë¦¼ì„ ìœ„í•´ ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥ (ì‹¤ì œë¡œëŠ” í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
            Console.WriteLine("í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private async Task ToggleFavorite(PromptItem prompt)
    {
        prompt.IsFavorite = !prompt.IsFavorite;

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¦ê²¨ì°¾ê¸° ìƒíƒœ ì €ì¥
        await SaveFavoritesToStorage();

        // í˜„ì¬ ì¦ê²¨ì°¾ê¸° í•„í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í‘œì‹œ ëª©ë¡ ì—…ë°ì´íŠ¸
        if (showFavoritesOnly)
        {
            ApplyFilters();
        }
        else
        {
            StateHasChanged();
        }
    }
    
    private async Task LoadFavoritesFromStorage()
    {
        try
        {
            var favoritesJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "favorites");
            if (!string.IsNullOrEmpty(favoritesJson))
            {
                var favoriteIds = System.Text.Json.JsonSerializer.Deserialize<List<string>>(favoritesJson);
                if (favoriteIds != null)
                {
                    // ì „ì²´ í”„ë¡¬í”„íŠ¸ ëª©ë¡ì´ ìˆëŠ” ê²½ìš°
                    if (allPrompts != null)
                    {
                        foreach (var prompt in allPrompts)
                        {
                            prompt.IsFavorite = favoriteIds.Contains(prompt.Id);
                        }
                    }
                    
                    // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ìˆëŠ” ê²½ìš°
                    if (selectedPrompt != null)
                    {
                        selectedPrompt.IsFavorite = favoriteIds.Contains(selectedPrompt.Id);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load favorites from storage: {ex.Message}");
        }
    }
    
    private async Task SaveFavoritesToStorage()
    {
        try
        {
            var favoriteIds = new List<string>();
            
            // ì „ì²´ í”„ë¡¬í”„íŠ¸ ëª©ë¡ì—ì„œ ì¦ê²¨ì°¾ê¸° ì¶”ì¶œ
            if (allPrompts != null)
            {
                favoriteIds.AddRange(allPrompts.Where(p => p.IsFavorite).Select(p => p.Id));
            }
            
            // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ì¦ê²¨ì°¾ê¸°ì¸ ê²½ìš° ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            if (selectedPrompt?.IsFavorite == true && !favoriteIds.Contains(selectedPrompt.Id))
            {
                favoriteIds.Add(selectedPrompt.Id);
            }
            
            // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°ëœ ê²½ìš° ì œê±°
            if (selectedPrompt?.IsFavorite == false)
            {
                favoriteIds.Remove(selectedPrompt.Id);
            }

            var favoritesJson = System.Text.Json.JsonSerializer.Serialize(favoriteIds.Distinct().ToList());
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "favorites", favoritesJson);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to save favorites to storage: {ex.Message}");
        }
    }
    
    public void Dispose()
    {
        _loadingCancellationTokenSource?.Cancel();
        _loadingCancellationTokenSource?.Dispose();
    }
}
