@page "/"
@inject PromptService PromptService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>MEGAZONE AIR Prompt</PageTitle>

<div class="home-container">
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">            <h1 class="hero-title" tabindex="-1">
                <span class="hero-icon">🚀</span>
                MEGAZONE AIR Prompt
            </h1>
            <p class="hero-subtitle">
                AI 시대를 위한 최고의 프롬프트 컬렉션<br>
                창의적인 아이디어와 효율적인 작업을 위한 완벽한 도구
            </p>
            
            <!-- Quick Search -->
            <div class="hero-search">
                <div class="search-container">
                    <input @bind="searchTerm" @onkeypress="OnSearchKeyPress"
                           placeholder="원하는 프롬프트를 검색해보세요..." 
                           class="search-input-large" />
                    <button class="search-btn-large" @onclick="PerformSearch">
                        <span class="search-icon">🔍</span>
                        검색
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Stats Section -->
        <div class="stats-section">
            <div class="stat-item">
                <div class="stat-number">@totalPrompts</div>
                <div class="stat-label">프롬프트</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">@totalCategories</div>
                <div class="stat-label">카테고리</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">@totalTags</div>
                <div class="stat-label">태그</div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features-section">
        <h2 class="section-title">주요 기능</h2>
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">💡</div>
                <h3>다양한 카테고리</h3>
                <p>비즈니스, 개발, 교육, 창작 등 다양한 분야의 프롬프트를 제공합니다</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">📋</div>
                <h3>원클릭 복사</h3>
                <p>마음에 드는 프롬프트를 클릭 한 번으로 클립보드에 복사할 수 있습니다</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">💖</div>
                <h3>즐겨찾기</h3>
                <p>자주 사용하는 프롬프트를 즐겨찾기에 추가하여 빠르게 접근하세요</p>
            </div>
        </div>
    </section>

    <!-- Categories Section -->
    <section class="categories-section">
        <h2 class="section-title">인기 카테고리</h2>
        <div class="categories-grid">
            @if (categories != null)
            {
                @foreach (var category in categories.Take(6))
                {
                    <div class="category-card" @onclick="() => NavigateToCategory(category)">
                        <div class="category-icon">@GetCategoryIcon(category)</div>
                        <h3>@category</h3>
                        <p>@GetCategoryCount(category)개의 프롬프트</p>
                    </div>
                }
            }
        </div>
        
        <div class="view-all-section">
            <button class="btn-primary" @onclick="ViewAllPrompts">
                모든 프롬프트 보기
            </button>
        </div>
    </section>

    <!-- Recent Prompts Section -->
    @if (recentPrompts?.Any() == true)
    {        <section class="recent-section">
            <h2 class="section-title">최근 업데이트된 프롬프트</h2>
            <div class="recent-prompts-grid">
                @foreach (var prompt in recentPrompts.Take(3))
                {
                    <PromptMiniCard Prompt="prompt" 
                                    OnCardClick="ViewPrompt" 
                                    OnToggleFavorite="ToggleFavorite" />
                }
            </div>
        </section>
    }
</div>

<!-- Prompt Modal -->
<PromptModal Prompt="selectedPrompt" 
             OnClose="CloseModal"
             OnCopyToClipboard="CopyToClipboard"
             OnToggleFavorite="ToggleFavorite" />

@code {
    private List<PromptItem>? allPrompts;
    private List<PromptItem>? recentPrompts;
    private List<string>? categories;
    private string searchTerm = "";
    private int totalPrompts = 0;
    private int totalCategories = 0;
    private int totalTags = 0;
    private PromptItem? selectedPrompt;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }    private async Task LoadData()
    {
        try
        {
            allPrompts = await PromptService.GetAllPromptsAsync();
            categories = await PromptService.GetCategoriesAsync();
            var tags = await PromptService.GetTagsAsync();

            totalPrompts = allPrompts?.Count ?? 0;
            totalCategories = categories?.Count ?? 0;
            totalTags = tags?.Count ?? 0;

            // 로컬 스토리지에서 즐겨찾기 상태 복원
            await LoadFavoritesFromStorage();

            recentPrompts = allPrompts?
                .OrderByDescending(p => p.UpdatedDate)
                .Take(6)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }

        StateHasChanged();
    }private void OnSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            PerformSearch();
        }
    }

    private void PerformSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            Navigation.NavigateTo($"/prompts?search={Uri.EscapeDataString(searchTerm)}");
        }
    }

    private void NavigateToCategory(string category)
    {
        Navigation.NavigateTo($"/prompts?category={Uri.EscapeDataString(category)}");
    }

    private void ViewAllPrompts()
    {
        Navigation.NavigateTo("/prompts");
    }

    private void ViewPrompt(string promptId)
    {
        selectedPrompt = allPrompts?.FirstOrDefault(p => p.Id == promptId);
        StateHasChanged();
    }

    private void CloseModal()
    {
        selectedPrompt = null;
        StateHasChanged();
    }
    
    private async Task CopyToClipboard(string content)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", content);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to copy to clipboard: {ex.Message}");
        }
    }
    
    private async Task ToggleFavorite(PromptItem prompt)
    {
        prompt.IsFavorite = !prompt.IsFavorite;
        
        // 로컬 스토리지에 즐겨찾기 상태 저장
        await SaveFavoritesToStorage();
        
        StateHasChanged();
    }

    private async Task LoadFavoritesFromStorage()
    {
        try
        {
            if (allPrompts == null) return;

            var favoritesJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "favorites");
            if (!string.IsNullOrEmpty(favoritesJson))
            {
                var favoriteIds = System.Text.Json.JsonSerializer.Deserialize<List<string>>(favoritesJson);
                if (favoriteIds != null)
                {
                    foreach (var prompt in allPrompts)
                    {
                        prompt.IsFavorite = favoriteIds.Contains(prompt.Id);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load favorites from storage: {ex.Message}");
        }
    }

    private async Task SaveFavoritesToStorage()
    {
        try
        {
            if (allPrompts == null) return;

            var favoriteIds = allPrompts.Where(p => p.IsFavorite).Select(p => p.Id).ToList();
            var favoritesJson = System.Text.Json.JsonSerializer.Serialize(favoriteIds);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "favorites", favoritesJson);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to save favorites to storage: {ex.Message}");
        }
    }

    private string GetCategoryIcon(string category)
    {
        return category.ToLower() switch
        {
            "business" or "비즈니스" => "💼",
            "development" or "개발" => "💻",
            "education" or "교육" => "📚",
            "writing" or "창작" => "✍️",
            "marketing" or "마케팅" => "📈",
            "design" or "디자인" => "🎨",
            _ => "📝"
        };
    }

    private int GetCategoryCount(string category)
    {
        return allPrompts?.Count(p => p.Category.Equals(category, StringComparison.OrdinalIgnoreCase)) ?? 0;
    }
}
